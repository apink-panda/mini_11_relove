<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-View Player - Apink å›æ­¸æ•´ç†</title>
    <link rel="stylesheet" href="static/css/style.css?v=20260118204705">
    <style>
        .controls {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid var(--glass-border);
        }

        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 15px;
            padding: 10px;
            border: 2px solid var(--primary-pink);
            border-radius: 8px;
            font-family: inherit;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
        }

        .btn {
            background-color: var(--primary-pink);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(248, 195, 205, 0.5);
        }

        .btn-secondary {
            background-color: #ccc;
        }

        #multi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        #multi-grid.vertical-mode {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            overflow-x: auto;
        }

        #multi-grid.vertical-mode .player-wrapper {
            flex: 1;
            /* Force equal width */
            /* Allow shrinking */
            min-width: 0;
            padding-bottom: 0;
            height: auto;
            /* Override base class height: 0 */
            aspect-ratio: 9/16;
            max-height: 85vh;
            /* Prevent excessive height */
        }

        .player-wrapper {
            position: relative;
            /* Default 56.25% (16:9), modified by toggle */
            padding-bottom: 56.25%;
            height: 0;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: padding-bottom 0.3s ease;
        }





        .player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="nav-header">
            <a href="index.html" class="btn btn-secondary">â† Back to Home</a>
            <h1>Multi-View Player</h1>
            <div style="width: 100px;"></div> <!-- Spacer for centering -->
        </header>

        <div class="controls">
            <p style="margin-bottom: 10px; color: #666;">Paste YouTube URLs below (one per line) / è«‹åœ¨ä¸‹æ–¹è²¼ä¸Š YouTube
                ç¶²å€ï¼ˆä¸€è¡Œä¸€å€‹ï¼‰</p>
            <textarea id="urlInput"
                placeholder="https://www.youtube.com/watch?v=...&#10;https://www.youtube.com/watch?v=..."></textarea>
            <br>
            <div style="margin: 15px 0;">
                <label style="margin-right: 15px; font-weight: bold; color: #444;">Aspect Ratio / æ¯”ä¾‹:</label>
                <label style="margin-right: 10px; cursor: pointer;">
                    <input type="radio" name="aspectRatio" value="16:9" checked onchange="changeRatio()"> Landscape
                    (16:9) / æ©«å‘
                </label>
                <label style="margin-right: 10px; cursor: pointer;">
                    <input type="radio" name="aspectRatio" value="9:16" onchange="changeRatio()"> Vertical (9:16) / ç›´ç«‹
                    (FanCam)
                </label>
            </div>
            <button class="btn" onclick="loadVideos()">Load Videos / è®€å–å½±ç‰‡</button>
            <button class="btn" onclick="playAll()" id="playBtn">â–¶ï¸ Play All / åŒæ­¥æ’­æ”¾</button>
            <button class="btn" onclick="togglePause()" id="pauseBtn" style="display:none;">â¸ï¸ Pause / æš«åœ</button>
            <button class="btn btn-secondary" onclick="restartAll()" id="restartBtn" style="display:none;">ğŸ”„ Restart /
                é‡æ–°é–‹å§‹</button>
            <button class="btn btn-secondary" onclick="clearAll()">Clear / æ¸…é™¤</button>
        </div>

        <div id="multi-grid"></div>
    </div>

    <script>
        var players = [];
        var playerStates = [];
        var isSyncing = false; // Flag for buffering phase

        // Load YouTube IFrame API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            // API loaded
        }

        function getVideoId(url) {
            var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            var match = url.match(regExp);
            if (match && match[2].length == 11) {
                return match[2];
            } else {
                return null;
            }
        }

        function getStartTime(url) {
            // Regex to match t=X, t=Xs, t=XmYs, etc.
            var regExp = /[?&]t=([0-9hms]+)/;
            var match = url.match(regExp);
            if (match && match[1]) {
                var timeStr = match[1];
                if (/^\d+$/.test(timeStr)) {
                    return parseInt(timeStr);
                }
                var seconds = 0;
                var h = timeStr.match(/(\d+)h/);
                var m = timeStr.match(/(\d+)m/);
                var s = timeStr.match(/(\d+)s/);
                if (h) seconds += parseInt(h[1]) * 3600;
                if (m) seconds += parseInt(m[1]) * 60;
                if (s) seconds += parseInt(s[1]);
                return seconds;
            }
            return 0;
        }

        var videoDataList = []; // Store video info for lazy loading

        function loadVideos() {
            var input = document.getElementById('urlInput').value;
            var lines = input.split('\n');
            var grid = document.getElementById('multi-grid');

            grid.innerHTML = '';
            players = [];
            playerStates = [];
            videoDataList = [];

            lines.forEach(function (line, index) {
                if (!line.trim()) return;
                var videoId = getVideoId(line.trim());
                var startTime = getStartTime(line.trim());
                if (videoId) {
                    var wrapper = document.createElement('div');
                    wrapper.className = 'player-wrapper';
                    if (currentRatio === '9:16') {
                        wrapper.classList.add('ratio-9-16');
                        grid.classList.add('vertical-mode');
                    } else {
                        grid.classList.remove('vertical-mode');
                    }
                    var divId = 'player-' + index + '-' + Date.now();

                    // Create thumbnail container instead of iframe
                    var thumbnailDiv = document.createElement('div');
                    thumbnailDiv.id = divId;
                    thumbnailDiv.className = 'thumbnail-container';
                    thumbnailDiv.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-position:center;';
                    thumbnailDiv.style.backgroundImage = 'url(https://img.youtube.com/vi/' + videoId + '/maxresdefault.jpg)';

                    wrapper.appendChild(thumbnailDiv);
                    grid.appendChild(wrapper);

                    // Store video data for later
                    videoDataList.push({
                        id: divId,
                        videoId: videoId,
                        startTime: startTime
                    });

                    playerStates.push({
                        id: divId,
                        ready: false,
                        startTime: startTime
                    });
                }
            });
        }

        function createPlayers() {
            // Create actual YouTube players from thumbnails
            videoDataList.forEach(function (data, index) {
                var player = new YT.Player(data.id, {
                    height: '100%',
                    width: '100%',
                    videoId: data.videoId,
                    playerVars: {
                        'start': data.startTime,
                        'playsinline': 1,
                        'controls': 0,
                        'rel': 0,
                        'modestbranding': 1,
                        'showinfo': 0,
                        'iv_load_policy': 3
                    },
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
                players.push(player);
            });
        }

        var isPaused = false;

        function playAll() {
            if (videoDataList.length === 0) return;

            // If players not created yet, create them first
            if (players.length === 0) {
                createPlayers();
                // Wait for players to be ready before starting sync
                setTimeout(startBuffering, 1000);
            } else {
                startBuffering();
            }
        }

        function startBuffering() {
            isSyncing = true;
            isPaused = false;
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').innerText = 'â³ Buffering...';
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('restartBtn').style.display = 'inline-block';

            // Reset readiness
            playerStates.forEach(s => s.ready = false);

            players.forEach(function (p) {
                if (p.playVideo) {
                    p.mute(); // Mute all during buffering
                    p.playVideo();
                }
            });
        }

        function togglePause() {
            if (players.length === 0) return;

            var pauseBtn = document.getElementById('pauseBtn');

            if (isPaused) {
                // Resume playback
                players.forEach(function (p, index) {
                    if (index === 0) {
                        p.unMute();
                    }
                    p.playVideo();
                });
                isPaused = false;
                pauseBtn.innerText = 'â¸ï¸ Pause / æš«åœ';
            } else {
                // Pause playback
                players.forEach(function (p) {
                    if (p.pauseVideo) p.pauseVideo();
                });
                isPaused = true;
                pauseBtn.innerText = 'â–¶ï¸ Resume / ç¹¼çºŒ';
            }
        }

        function restartAll() {
            if (players.length === 0) return;

            // Seek all players to their start time
            players.forEach(function (p, index) {
                if (p.seekTo) {
                    p.seekTo(playerStates[index].startTime);
                }
            });

            // Reset and start synchronized playback
            isPaused = false;
            isSyncing = true;
            document.getElementById('pauseBtn').innerText = 'â³ Buffering...';
            document.getElementById('pauseBtn').disabled = true;

            // Reset readiness
            playerStates.forEach(s => s.ready = false);

            players.forEach(function (p) {
                if (p.playVideo) {
                    p.mute();
                    p.playVideo();
                }
            });
        }

        var currentRatio = '16:9';

        function changeRatio() {
            var radios = document.getElementsByName('aspectRatio');
            for (var i = 0, length = radios.length; i < length; i++) {
                if (radios[i].checked) {
                    currentRatio = radios[i].value;
                    break;
                }
            }

            var grid = document.getElementById('multi-grid');
            if (currentRatio === '9:16') {
                grid.classList.add('vertical-mode');
            } else {
                grid.classList.remove('vertical-mode');
            }

            var wrappers = document.getElementsByClassName('player-wrapper');
            for (var i = 0; i < wrappers.length; i++) {
                if (currentRatio === '9:16') {
                    wrappers[i].classList.add('ratio-9-16');
                } else {
                    wrappers[i].classList.remove('ratio-9-16');
                }
            }
        }
        function clearAll() {
            document.getElementById('multi-grid').innerHTML = '';
            players = [];
            playerStates = [];
            videoDataList = [];
            document.getElementById('urlInput').value = '';
            isSyncing = false;
            isPaused = false;
            document.getElementById('playBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'none';
        }

        function onPlayerStateChange(event) {
            if (isSyncing) {
                if (event.data === YT.PlayerState.PLAYING) {
                    // Find which player this is
                    var playerIndex = players.findIndex(p => p.getIframe().id === event.target.getIframe().id);
                    if (playerIndex !== -1 && !playerStates[playerIndex].ready) {
                        event.target.pauseVideo(); // Pause immediately
                        event.target.seekTo(playerStates[playerIndex].startTime); // Ensure start time
                        playerStates[playerIndex].ready = true;

                        // Check if all are ready
                        var allReady = playerStates.every(s => s.ready);
                        var readyCount = playerStates.filter(s => s.ready).length;
                        document.getElementById('pauseBtn').innerText = `â³ Buffering ${readyCount}/${players.length}...`;

                        if (allReady) {
                            startSynchronizedPlayback();
                        }
                    }
                }
            }
        }

        function startSynchronizedPlayback() {
            isSyncing = false;
            document.getElementById('pauseBtn').innerText = 'â¸ï¸ Pause / æš«åœ';
            document.getElementById('pauseBtn').disabled = false;

            players.forEach(function (p, index) {
                if (index === 0) {
                    p.unMute(); // Only unmute the first one
                } else {
                    p.mute();
                }
                p.playVideo();
            });
        }
    </script>
</body>

</html>